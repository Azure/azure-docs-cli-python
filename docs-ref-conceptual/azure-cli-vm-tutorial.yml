#YamlMime: Tutorial
title: Create virtual machines with the Azure CLI 2.0
metadata:
    title: Create virtual machines with the Azure CLI 2.0
    description: Get started with the Azure CLI by creating virtual machines.
    audience: IT Pro
    level: Beginner
    displayType: two-column
    interactive: azurecli
items:
    durationInMinutes: 1
    content: >-
        In this tutorial, you learn all of the steps involved in setting up a virtual machine with the Azure CLI 2.0.
        This tutorial also covers querying CLI outputs to extract information, and how to re-use secondary resources
        created as part of this initial VM setup.

        You can use the interactive experience offered as part of this tutorial, or [install the CLI](install-azure-cli.md)
        locally.

    durationInMinutes: 1
    title: Log in
    content: >-
        If you're using a local install of the CLI, you need to log in before perofrming
        any other steps. If you're using the interactive experience through cloud shell,
        you've already been logged in.

        ```azurecli
        az login
        ```

        Follow the steps displayed in your terminal to complete the log in process.

    durationInMinutes: 1
    title: Create a resource group
    content: >-
        In Azure, resources are tied together in a resource management group to allow them
        to link together. For this tutorial all of the created resources will go into a
        single group.

        ```azurecli
        az group create --name CLITutorial --location eastus
        ```

        > [!NOTE]
        > If you change the location of this resource group, some resources in this
        > tutorial may not be able to be created due to datacenter availability.

    durationInMinutes: 1
    title: Create a virtual machine
    content: >-
        Virtual machines in Azure are complicated resources which have a large number of
        dependencies. Fortunately, the CLI creates these resources for you
        based on the command line arguments you specify. In this step we're going to
        create a virtual machine, and then get information on some of those created
        resources with `--query` so that they can be used in the creation of additional
        virtual machines.

        Start by creating a single new virtual machine running Ubuntu which uses SSH authentication for login.

        ```azurecli
        az vm create --resource-group CLITutorial --name TutorialVM1 --image UbuntuLTS --generate-ssh-keys
        ```

        > [!NOTE]
        > If you have an SSH key named `id_rsa` already available, this key is used for authentication rather than having a new
        > key generated.

        Once the VM is created, you will get a small amount of information in your terminal, including the public IP address.
        Try connecting to the VM over SSH to make sure that it is up and running.

        ```bash
        ssh <PUBLIC_IP_ADDRESS>
        ```

        Go ahead and log out from the VM. There are better ways to get this IP address, and other information about the VM itself -
        what virtual network it's on, if it has assigned FQDNs, and whether or not it is powered on. You'll now learn how to use the
        `--query` command to get that information, and combine it with UNIX command-line tools to extract and save values.

    durationInMinutes: 1
    title: Show and query VM information
    content: >-
        The common command for getting information from a resource is `show`. Go ahead and try it now for the VM that was just created.

        ```azurecli
        az vm show --name TutorialVM1 --resource-group CLITutorial
        ```

        You'll see an overwhelming amount of information, which can be difficult to parse or even scroll through. The information returned
        contains details on authentication with the VM, the network interface it connects to, and the storage that it uses. Most importantly,
        it contains the Azure Object IDs for reosurces that the VM is directly connected to. Since we want to save the public IP address,
        start by getting the NIC object ID so that we can query that.

        ```azurecli
        az vm show --name TutorialVM1 --resource-group CLITutorial --query 'networkProfile.networkInterfaces[].id' --output tsv
        ```

        There's a lot new going on here, just by adding the query.

        * Breaking down the query, it references fields of the JSON output that can be found with visual inspection and
          subsequent queries. `networkProfile` is a key of the toplevel JSON, which has `networkInterfaces` as a subkey.
          Because the value here is an array, it is "flattened" with the `[]` operator, which runs the query strings
          following it on each array element. This extracts the `id` field from each `networkInterfaces` element,
          giving us the object ID that we are looking for.
        * The output format `tsv` is guaranteed to only include the data queried, and whitespace. Since we know there will be
          at most one value returned, this will print _only_ the data.

        Now that we know how to get this value, this command can be executed to store it in a shell variable.

        ```bash
        NIC_ID=`az vm show -n TutorialVM1 -g CLITutorial --query 'networkProfile.networkInterfaces[].id' -o tsv`
        ```

        This example also demonstrates the use of short arguments, which are available for some of the most common arguments passed to
        the CLI.

        Now that we have the NIC ID, we can run `az network nic show` to get the information on the NIC itself.

        ```azurecli
        az network nic show --ids $NIC_ID -g CLITutorial
        ```

        Again, this displays a lot of information - DNS settings, IP information, security settings, MAC address, and so on. Right now
        we're interested in the public IP address and the name of the subnet. Go ahead and pull that information with a query.

        ```azurecli
        az network nic show --ids $NIC_ID -g CLITutorial --query '{IP:ipConfigurations[].publicIpAddress.id, Subnet:ipConfigurations[].subnet.id}'
        ```

        This displays a JSON object which has custom identifiers ('IP' and 'Subnet') for the extracted values. While this might not be useful
        for command-line tools, it helps with human readability and you can take this JSON and pipe it to our own custom scripts or software.

        What we can do, though, is take this output and rather than re-tag it, output it as tab-separated values (TSV). This can be processed by
        the shell `read` command to load results into multiple variables.

        ```bash
        read -d '' IP_ID SUBNET_ID <<< $(az network nic show --ids $NIC_ID -g CLITutorial --query '[ipConfigurations[].publicIpAddress.id, ipConfigurations[].subnet.id]' -o tsv)
        ```

        We won't use the subnet ID right away, but because it can be obtained in this single query, it's useful to store it for later. Instead what we will
        now do is use the IP ID to look up the public IP address object in Azure, and store the IP address in a shell variable.

        ```bash
        read VM1_IP_ADDR <<< $(az network public-ip show --ids $IP_ID -g CLITutorial --query ipAddress -o tsv)
        ```

        Now we've got the IP address of our VM that can easily be connected to. The next step is to create a second VM, on the same subnet, so that
        these VMs can be easily connected and later grouped together.

    durationInMinutes: 1
    title: Creating a VM on the same subnet
    content: >-

        Our second VM is going to be created in a similar way, with one important difference. We already have a subnet available, and
        want the new VM to reuse it. We can also skip a few steps to get the public IP address of the new VM stored into an environment
        variable right away, since it's returned in the VM creation information.

        ```bash
        VM2_IP_ADDR=$(az vm create --resource-group CLITutorial --name TutorialVM2 --image UbuntuLTS --generate-ssh-keys --subnet $SUBNET_ID --query publicIpAddress -o tsv)
        ```

        You can now SSH into this new VM easily.

        ```bash
        ssh $VM2_IP_ADDR
        ```
    
    durationInMinutes: 1
    title: Cleanup
    content: >-
        Now that you've completed the tutorial, it's time to clean up the created resources. While you
        can delete individual resources with the `delete` command from each command group (i.e.
        `storage account delete`, `vm delete`, etc.) the fastest way to remove all resources
        that have been put together into the same resource group is with `group delete`.

        ```azurecli
        az group delete --name CLITutorial --no-wait
        ```

        This command deletes the resources created during the tutorial, and is guaranteed to deallocate
        them in the correct order. The `--no-wait` parameter keeps the CLI from blocking while the
        deletion takes place -- this can take quite a while! If you decide that you want to wait
        until the deletion is complete, or watch it progress, you can always use the `group wait`
        command.
        
        ```azurecli
        az group wait --name CLITutorial --deleted
        ```

        With cleanup completed, the tutorial is completed. Continue on for a summary of everything
        you've learned and links to resources that will help you with your next steps.

    durationInMinutes: 1
    title: Summary
    content: >-
        Congratluations! You've learned how to create VMs, use the `--query` and `--output` arguments to capture data to be stored in shell variables, and
        looked into some of the resources that get created as part of the VM construction process.

        Where you go from here depends on what you plan to use the CLI for. We offer
        a variety of materials that go further in depth on the fatures covered in
        this tutorial.

        ## Samples

        If you want to get started right away with samples that show how to achieve specific
        tasks with the CLI, we offer a number of sample scripts.

        * Working with [Linux VMs](/azure/virtual-machines/linux/cli-samples?toc=%2fcli%2fazure%2ftoc.json) and [Windows VMs](/azure/virtual-machines/windows/cli-samples?toc=%2fcli%2fazure%2ftoc.json)
        * Working with [webapps](/azure/app-service/app-service-cli-samples?toc=%2Fcli%2Fazure%2Ftoc.json) and [Azure Functions](/azure/azure-functions/functions-cli-samples?toc=%2fcli%2fazure%2ftoc.json)
        * Working with databases - [Azure SQL databases](/azure/sql-database/sql-database-cli-samples?toc=%2fcli%2fazure%2ftoc.json), [PostgreSQL](/azure/postgresql/sample-scripts-azure-cli?toc=%2fcli%2fazure%2ftoc.json), [MySQL](/azure/mysql/sample-scripts-azure-cli?toc=%2fcli%2fazure%2ftoc.json), and [CosmosDB](/azure/cosmos-db/cli-samples?toc=%2fcli%2fazure%2ftoc.json).

        ## In-depth CLI documentation

        There are also topics that go deeper into the CLI features that were shown
        in the tutorial.
        
        * Learn more about [output formats](format-output-azure-cli.md)
        * Learn more about [output queries](query-azure-cli.md)
        * Learn more about [login and authorization](authenticate-azure-cli.md)

        ## Other useful documentation
        
        You might also want to take time to explore some more advanced features of
        the CLI, like [configuring defaults](azure-cli-configuration.md) or [extensions](azure-cli-extensions.md).

        We hope that you have an enjoyable and useful experience with the Azure CLI!

